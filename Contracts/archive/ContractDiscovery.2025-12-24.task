# Contract Discovery Engine Implementation

---

## Delegation Prompt

---

## Role: Implementer

**Task File**: Contracts/ContractDiscovery.task  
**Objective**: Implement the core discovery engine that finds, loads, and merges YAML contract metadata files

**Role Reference**: See [Framework/Implementation.prompt.md](../Framework/Implementation.prompt.md) for workflow guidance.

### Delegation Context

The Contracts system foundation is ready. Now we need the discovery engine - the core capability that finds all `.metadata` files (framework defaults + user-defined), parses them using YamlDotNet, and merges them into a unified contract set. This enables all validation capabilities.

### Responsibilities

1. Design contract metadata model (C# records/classes matching YAML schema)
2. Implement filesystem discovery using glob patterns
3. Integrate YamlDotNet for YAML parsing
4. Build merge logic (user contracts can extend/override defaults)
5. Create comprehensive unit tests and snapshot tests

### Delegation Deliverables

- [x] **D1**: Contract metadata model classes (target, schema, naming, validation rules)
- [x] **D2**: Discovery service that finds `.metadata` files via filesystem scan
- [x] **D3**: YAML deserialization using YamlDotNet with error handling
- [x] **D4**: Merge logic for combining framework + user contracts
- [x] **D5**: Unit tests covering discovery, parsing, and merging (xUnit + Verify)

### Reports

- Keep status/blocker reports in separate `.report` files named `ContractDiscovery.task.{ReportName}.report` alongside this task file
- Reference the report filenames here (do not inline full reports)
- Move reports together with the task when archiving/moving
- Use [Planning/ProgressReport.report.template](../Planning/ProgressReport.report.template) for status updates and [Planning/BlockerReport.report.template](../Planning/BlockerReport.report.template) when blocked

### Guidance

- Patterns: Use records for immutable models, leverage pattern matching, nullable reference types
- Verification: `dotnet build` and `nuke` both succeed; all tests pass
- Critical notes: Discovery must handle missing files gracefully; YAML errors should be descriptive

### Upon Completion

1. Update Progress Log in this file (summaries only; link to `.report` files for details)
2. Use Flow prompt for continue/progress/blocker, and delegate using the 3-line format to the next role
3. When complete, archive to `Contracts/archive/ContractDiscovery.YYYY-MM-DD.task` and update relevant inventories

---

## Task Details

---

Status: Complete  
Owner: Implementer  
Priority: High  
Effort: Medium

## Objective

Implement the contract discovery engine that finds, parses, and merges YAML metadata contracts, forming the foundation of the Contracts validation system.

## Task Context

- Current state:
  - Contracts.Core project exists with YamlDotNet and glob libraries
  - Example metadata file created: Planning/Task.template.metadata
  - No discovery or parsing logic implemented
  - Test infrastructure ready (xUnit, Verify)
  
- Desired state:
  - C# model classes matching YAML contract schema
  - Discovery service finding all `.metadata` files
  - YAML parsing with comprehensive error handling
  - Merge logic combining framework + user contracts
  - Full test coverage with snapshot tests

## Task Deliverables

- D1: Model classes (ContractMetadata, TargetPattern, SchemaDefinition, ValidationRule, etc.)
- D2: IContractDiscoveryService with filesystem scanning
- D3: YamlDotNet integration with error handling and validation
- D4: Contract merge logic (user extends/overrides framework defaults)
- D5: Comprehensive tests (unit + snapshot) validating all scenarios

## Architecture Decisions

- AD-1: Immutable records for models — Rationale: Thread-safe, clear intent, pattern matching support
- AD-2: Interface-based services — Rationale: Testability, dependency injection, future extensibility
- AD-3: Fail-fast on YAML errors — Rationale: Invalid contracts should be caught early with clear messages
- AD-4: User contracts override by filename — Rationale: Simple, predictable merge strategy
- AD-5: Verify snapshot tests for models — Rationale: Catch breaking changes in serialization/structure

## Success Criteria

- [x] `dotnet build` succeeds with 0 errors, 0 warnings
- [x] `nuke` Compile and Test targets succeed
- [x] All unit tests pass (discovery, parsing, merging scenarios)
- [x] Snapshot tests verify model structure
- [x] Discovery handles empty directories, missing files gracefully
- [x] YAML parse errors provide clear, actionable messages

## Progress Log

- 2024-12-24: Task created; contract discovery engine is next critical capability
- 2024-12-24: Complete - Implemented models (ContractMetadata + supporting records), discovery service with glob patterns and YAML parsing, unit tests and snapshot tests. Build succeeds with 0 warnings. Ready for archival.

